{% extends 'base.html' %}
{% load static %}

{% block title %}Pharmacy Reports - Nora Dental Clinic{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-bar me-2"></i>Pharmacy Reports & Analytics
        </h1>
        <p class="dashboard-subtitle">Comprehensive pharmacy performance metrics and statistics</p>
    </div>

    <!-- Report Period Info -->
    <div class="report-period-card mb-4">
        <i class="fas fa-calendar-alt me-2"></i>
        <span class="period-label">Report Period:</span>
        <span class="period-value">{{ date_range }}</span>
    </div>

    <!-- Summary Metrics Grid -->
    <div class="metrics-grid">
        <div class="metric-card metric-card-gradient-1">
            <div class="metric-icon">
                <i class="fas fa-pills"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Dispensed</div>
                <div class="metric-value">{{ total_dispensed }}</div>
                <div class="metric-subtitle">Last 30 days</div>
            </div>
        </div>
        <div class="metric-card metric-card-gradient-2">
            <div class="metric-icon">
                <i class="fas fa-capsules"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Total Medicines</div>
                <div class="metric-value">{{ total_medicines }}</div>
                <div class="metric-subtitle">In inventory</div>
            </div>
        </div>
        <div class="metric-card metric-card-gradient-3">
            <div class="metric-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-content">
                <div class="metric-label">Low Stock Items</div>
                <div class="metric-value">{{ low_stock_count }}</div>
                <div class="metric-subtitle">Need attention</div>
            </div>
        </div>
    </div>

    <!-- Most Dispensed Items Table -->
    <div class="data-table-card mb-4">
        <div class="table-card-header">
            <h5 class="table-title">
                <i class="fas fa-trophy me-2"></i>Most Dispensed Items
            </h5>
            <div class="table-actions">
                <input type="text" id="searchReport" class="search-input" placeholder="Search medicines...">
                <button class="action-btn btn-export" onclick="exportReport('dispensing')">
                    <i class="fas fa-file-excel me-2"></i>Export
                </button>
            </div>
        </div>
        <div class="table-card-body">
            {% if most_dispensed %}
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Rank</th>
                            <th>Medicine Name</th>
                            <th style="width: 150px;">Times Dispensed</th>
                            <th style="width: 200px;">Popularity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in most_dispensed %}
                        <tr class="table-row-hover">
                            <td>
                                {% if forloop.counter == 1 %}
                                    <span class="rank-badge rank-gold">
                                        <i class="fas fa-crown me-1"></i>#1
                                    </span>
                                {% elif forloop.counter == 2 %}
                                    <span class="rank-badge rank-silver">
                                        <i class="fas fa-medal me-1"></i>#2
                                    </span>
                                {% elif forloop.counter == 3 %}
                                    <span class="rank-badge rank-bronze">
                                        <i class="fas fa-medal me-1"></i>#3
                                    </span>
                                {% else %}
                                    <span class="rank-number">#{{ forloop.counter }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="medicine-name">{{ item.pharmacy_stock__item__name }}</div>
                            </td>
                            <td>
                                <span class="dispense-count">{{ item.total }} times</span>
                            </td>
                            <td>
                                <div class="popularity-bar">
                                    {% widthratio item.total most_dispensed.0.total 100 as percentage %}
                                    <div class="popularity-fill" style="width: {{ percentage }}%;">
                                        <span class="popularity-text">{{ percentage }}%</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar fa-4x mb-3"></i>
                    <h5>No Dispensing Data</h5>
                    <p class="text-muted">No dispensing data available for the selected period</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Export Reports Section -->
    <div class="data-table-card">
        <div class="table-card-header">
            <h5 class="table-title">
                <i class="fas fa-download me-2"></i>Export Reports
            </h5>
        </div>
        <div class="table-card-body p-4">
            <div class="export-grid">
                <div class="export-card export-card-excel">
                    <div class="export-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="export-content">
                        <h6 class="export-title">Dispensing Report</h6>
                        <p class="export-description">Complete dispensing history with patient details</p>
                    </div>
                    <button class="export-btn" onclick="exportReport('dispensing')">
                        <i class="fas fa-download me-2"></i>Export Excel
                    </button>
                </div>
                <div class="export-card export-card-stock">
                    <div class="export-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="export-content">
                        <h6 class="export-title">Stock Report</h6>
                        <p class="export-description">Current inventory levels and stock details</p>
                    </div>
                    <button class="export-btn" onclick="exportReport('stock')">
                        <i class="fas fa-download me-2"></i>Export Excel
                    </button>
                </div>
                <div class="export-card export-card-pdf">
                    <div class="export-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="export-content">
                        <h6 class="export-title">Analytics PDF</h6>
                        <p class="export-description">Comprehensive analytics with charts and graphs</p>
                    </div>
                    <button class="export-btn" onclick="exportReport('analytics')">
                        <i class="fas fa-download me-2"></i>Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Dashboard Header */
    .dashboard-header { text-align: center; margin-bottom: 2rem; }
    .dashboard-title { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
    .dashboard-subtitle { color: #9ca3af; font-size: 1rem; }

    /* Report Period Card */
    .report-period-card { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 15px 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .report-period-card i { color: #3b82f6; font-size: 1.2rem; }
    .period-label { color: #9ca3af; font-weight: 500; }
    .period-value { color: white; font-weight: 600; }

    /* Modern Metrics Grid */
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .metric-card { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); border-radius: 16px; padding: 25px; display: flex; align-items: center; gap: 20px; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; position: relative; overflow: hidden; }
    .metric-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0; transition: opacity 0.3s ease; z-index: 0; }
    .metric-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
    .metric-card:hover::before { opacity: 1; }
    .metric-card-gradient-1::before { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); }
    .metric-card-gradient-2::before { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); }
    .metric-card-gradient-3::before { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); }
    .metric-icon { width: 70px; height: 70px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0; position: relative; z-index: 1; }
    .metric-card-gradient-1 .metric-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .metric-card-gradient-2 .metric-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .metric-card-gradient-3 .metric-icon { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; }
    .metric-content { flex: 1; position: relative; z-index: 1; }
    .metric-label { font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-value { font-size: 2.5rem; font-weight: 700; color: white; line-height: 1; margin-bottom: 0.5rem; }
    .metric-subtitle { font-size: 0.75rem; color: #6b7280; }

    /* Data Table Card */
    .data-table-card { background: rgba(255, 255, 255, 0.03); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1); overflow: visible; min-height: 400px; display: block !important; }
    .table-card-header { padding: 20px 25px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .table-title { margin: 0; font-size: 1.25rem; font-weight: 600; color: white; display: flex; align-items: center; }
    .table-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .search-input { padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: white; font-size: 0.875rem; min-width: 250px; transition: all 0.3s ease; }
    .search-input:focus { outline: none; border-color: #667eea; background: rgba(255, 255, 255, 0.08); }
    .search-input::placeholder { color: #6b7280; }
    .action-btn { padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; }
    .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .btn-export { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .btn-export:hover { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
    .table-card-body { padding: 0; display: block !important; }

    /* Modern Table */
    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; display: table !important; }
    .modern-table thead { background: rgba(255, 255, 255, 0.05); display: table-header-group !important; }
    .modern-table tbody { display: table-row-group !important; }
    .modern-table thead th { padding: 16px 20px; text-align: left; font-weight: 600; font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .modern-table tbody tr { transition: all 0.2s ease; display: table-row !important; }
    .table-row-hover:hover { background: rgba(255, 255, 255, 0.05); }
    .modern-table tbody td { padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #e5e7eb; font-size: 0.875rem; }

    /* Rank Badges */
    .rank-badge { padding: 6px 14px; border-radius: 14px; font-size: 0.875rem; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
    .rank-gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); }
    .rank-silver { background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); color: #1f2937; box-shadow: 0 4px 12px rgba(156, 163, 175, 0.3); }
    .rank-bronze { background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%); color: white; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3); }
    .rank-number { color: #9ca3af; font-weight: 600; font-size: 0.875rem; }
    .medicine-name { color: white; font-weight: 600; font-size: 0.95rem; }
    .dispense-count { padding: 6px 14px; background: rgba(16, 185, 129, 0.15); color: #10b981; border-radius: 12px; font-weight: 600; font-size: 0.85rem; }

    /* Popularity Bar */
    .popularity-bar { background: rgba(255, 255, 255, 0.05); border-radius: 8px; height: 28px; position: relative; overflow: hidden; }
    .popularity-fill { background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; transition: width 0.5s ease; border-radius: 8px; }
    .popularity-text { color: white; font-weight: 600; font-size: 0.75rem; }

    /* Export Grid */
    .export-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .export-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 15px; transition: all 0.3s ease; }
    .export-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); }
    .export-card-excel { border-color: rgba(16, 185, 129, 0.3); }
    .export-card-excel:hover { border-color: rgba(16, 185, 129, 0.6); background: rgba(16, 185, 129, 0.05); }
    .export-card-stock { border-color: rgba(59, 130, 246, 0.3); }
    .export-card-stock:hover { border-color: rgba(59, 130, 246, 0.6); background: rgba(59, 130, 246, 0.05); }
    .export-card-pdf { border-color: rgba(239, 68, 68, 0.3); }
    .export-card-pdf:hover { border-color: rgba(239, 68, 68, 0.6); background: rgba(239, 68, 68, 0.05); }
    .export-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .export-card-excel .export-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .export-card-stock .export-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .export-card-pdf .export-icon { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .export-content { flex: 1; }
    .export-title { color: white; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .export-description { color: #9ca3af; font-size: 0.875rem; margin: 0; }
    .export-btn { padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .export-card-excel .export-btn:hover { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
    .export-card-stock .export-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
    .export-card-pdf .export-btn:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
    .empty-state i { color: #4b5563; margin-bottom: 1rem; }
    .empty-state h5 { color: #9ca3af; margin-bottom: 0.5rem; }

    /* Responsive Design */
    @media (max-width: 768px) {
        .metrics-grid, .export-grid { grid-template-columns: 1fr; }
        .table-card-header { flex-direction: column; align-items: stretch; }
        .table-actions { flex-direction: column; }
        .search-input { min-width: 100%; }
    }
</style>

<script>
    function exportReport(type) {
        alert('Exporting ' + type + ' report...\nThis feature will generate and download the report.');
        // TODO: Implement report export functionality
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchReport');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const table = document.querySelector('.modern-table');
                if (table) {
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                }
            });
        }
    });
</script>
{% endblock %}
